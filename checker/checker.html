<!doctype html>
<meta charset="utf-8">
<title>LEGO Arm API Tester</title>
<style>
body{font-family:"72","Arial","sans-serif";max-width:800px;margin:32px auto;background:#f7f7f7;color:#32363a}
h1{color:#0a6ed1}
label{display:block;margin-top:12px}
input,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px}
button{padding:8px 12px;margin-top:8px;background:#0a6ed1;color:#fff;border:none;border-radius:4px;cursor:pointer}
button:hover{background:#0854a0}
pre{background:#111;color:#0f0;padding:12px;white-space:pre-wrap}
.nudge-row{display:flex;align-items:center;margin-top:8px}
.nudge-row span{flex:0 0 40px}
.btn-group{display:flex;gap:8px;flex:1}
.btn-group button{flex:1}
</style>

<h1>LEGO Arm API Tester</h1>
<label>Base URL (Pi or ngrok): <input id="base" value="http://127.0.0.1:8000"></label>
<label>API Key: <input id="key" placeholder="paste your API key"></label>

<button onclick="call('GET','/v1/health')">GET /v1/health</button>
<button onclick="call('GET','/v1/inventory',null,true)">GET /v1/inventory (auth)</button>
<button onclick="pose('home')">POST /v1/arm/pose {name:'home'}</button>

<h3>Custom move</h3>
<textarea id="moveBody" rows="6">{ "mode":"relative", "units":"degrees", "joints": {"A": 10, "B": -5}, "speed": 40, "finalize": true }</textarea>
<button onclick="postJson('/v1/arm/move', moveBody.value)">POST /v1/arm/move</button>

<h3>Manual motor nudges</h3>
<label>Step:
  <select id="step">
    <option value="10">10r</option>
    <option value="20">20r</option>
    <option value="50">50r</option>
    <option value="100">100r</option>
  </select>
</label>
<div id="nudges">
  <div class="nudge-row"><span>A</span><div class="btn-group">
    <button class="minus" onclick="nudge('A', -step())"></button>
    <button class="plus" onclick="nudge('A', step())"></button>
  </div></div>
  <div class="nudge-row"><span>B</span><div class="btn-group">
    <button class="minus" onclick="nudge('B', -step())"></button>
    <button class="plus" onclick="nudge('B', step())"></button>
  </div></div>
  <div class="nudge-row"><span>C</span><div class="btn-group">
    <button class="minus" onclick="nudge('C', -step())"></button>
    <button class="plus" onclick="nudge('C', step())"></button>
  </div></div>
  <div class="nudge-row"><span>D</span><div class="btn-group">
    <button class="minus" onclick="nudge('D', -step())"></button>
    <button class="plus" onclick="nudge('D', step())"></button>
  </div></div>
</div>

<pre id="out"></pre>

<script>
async function call(method, path, body=null, auth=false){
  // Normalize the base URL by removing trailing slashes. The previous regex
  // mistakenly removed backslashes instead of forward slashes, which could
  // lead to URLs like "https://host//v1/health" that some proxies mis-handle.
  const base=document.getElementById('base').value.trim().replace(/\/+$/,'');
  const key=document.getElementById('key').value.trim();
  const headers={};
  if(body!=null) headers["content-type"]="application/json";
  if(auth && key) headers["x-api-key"]=key;
  if(/\.ngrok/.test(base)) headers["ngrok-skip-browser-warning"]="1";
  const url=base+path;
  try{
    const res=await fetch(url,{method,headers,body});
    const text=await res.text();
    document.getElementById('out').textContent = res.status+" "+res.statusText+"\n\n"+text;
  }catch(err){
    document.getElementById('out').textContent = 'Fetch error: '+err;
  }
}
function postJson(path, json){ return call('POST', path, json, true); }
function pose(name){ return postJson('/v1/arm/pose', JSON.stringify({name, speed:60})); }
function step(){
  return parseInt(document.getElementById('step').value) || 10;
}
function updateNudgeLabels(){
  const s=step();
  document.querySelectorAll('#nudges .minus').forEach(b=>b.textContent=`-${s}r`);
  document.querySelectorAll('#nudges .plus').forEach(b=>b.textContent=`+${s}r`);
}
document.getElementById('step').addEventListener('change', updateNudgeLabels);
updateNudgeLabels();
function nudge(joint, rot){
  const body=JSON.stringify({mode:"relative", units:"rotations", joints:{[joint]:rot}, speed:40});
  return postJson('/v1/arm/move', body);
}
const moveBody=document.getElementById('moveBody');
</script>
