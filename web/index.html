<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>LEGO Arm Control</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=72&display=swap">
<style>
body{font-family:"72",Arial,sans-serif;margin:0;background:#f5f6f7;color:#32363a}
header{background:#0a6ed1;color:#fff;padding:16px;font-size:20px}
main{max-width:900px;margin:20px auto;padding:0 20px}
section{background:#fff;padding:16px;margin:16px 0;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
label{display:block;margin-top:8px}
input,button{padding:8px;font-size:14px;margin-top:4px}
button{background:#0a6ed1;border:none;color:#fff;border-radius:2px;cursor:pointer;margin-right:8px}
button:disabled{background:#9ca3af}
pre{background:#000;color:#0f0;padding:10px;overflow:auto}
#stateTable th{text-align:left;padding-right:8px}
</style>
</head>
<body>
<header>LEGO Arm Control</header>
<main>
<section id="auth">
<label>API Key <input type="password" id="apiKey"></label>
<label>Base URL <input id="base" placeholder="http://localhost:8000"></label>
<button onclick="connect()">Connect</button>
</section>
<section id="status">
<h2>Status</h2>
<div id="statusText">Not connected.</div>
<table id="stateTable"></table>
</section>
<section>
<h2>Poses</h2>
<button onclick="pose('home')">Home</button>
<button onclick="pose('pick_left')">Pick Left</button>
<button onclick="pose('pick_right')">Pick Right</button>
<button onclick="pose('place_left')">Place Left</button>
<button onclick="pose('place_right')">Place Right</button>
</section>
<section>
<h2>Custom Move</h2>
<div class="grid">
<label>Joint A <input id="jointA" type="number" value="0"></label>
<label>Joint B <input id="jointB" type="number" value="0"></label>
<label>Joint C <input id="jointC" type="number" value="0"></label>
<label>Joint D <input id="jointD" type="number" value="0"></label>
<label>Speed <input id="speed" type="number" value="60"></label>
<button onclick="move()">Move</button>
</div>
</section>
<section>
<h2>Emergency</h2>
<button onclick="stop()">Stop</button>
</section>
<section>
<h2>Log</h2>
<pre id="log" style="height:200px"></pre>
</section>
</main>
<script>
let poller;

function connect(){
  const base=document.getElementById('base').value.trim()||window.location.origin;
  document.getElementById('base').value=base;
  log('Base set to '+base);
  clearInterval(poller);
  poller=setInterval(()=>refreshState(base),2000);
  refreshState(base);
}

async function refreshState(base){
  try{
    const data=await api(base,'GET','/v1/arm/state');
    document.getElementById('statusText').textContent='OK';
    const t=document.getElementById('stateTable');
    t.innerHTML='';
    for(const [k,v] of Object.entries(data.abs_degrees)){
      const row=document.createElement('tr');
      row.innerHTML=`<th>${k}</th><td>${v.toFixed(1)}Â°</td>`;
      t.appendChild(row);
    }
  }catch(e){
    document.getElementById('statusText').textContent='Error';
  }
}

async function pose(name){
  const base=document.getElementById('base').value.trim()||window.location.origin;
  await api(base,'POST','/v1/arm/pose',{name,speed:60});
  refreshState(base);
}

async function move(){
  const base=document.getElementById('base').value.trim()||window.location.origin;
  const joints={};
  ['A','B','C','D'].forEach(j=>{
    const val=parseFloat(document.getElementById('joint'+j).value);
    if(val) joints[j]=val;
  });
  await api(base,'POST','/v1/arm/move',{mode:'relative',joints,speed:parseInt(document.getElementById('speed').value||'60')});
  refreshState(base);
}

async function stop(){
  const base=document.getElementById('base').value.trim()||window.location.origin;
  await api(base,'POST','/v1/arm/stop',{reason:'ui stop'});
}

async function api(base,method,path,body){
  const key=document.getElementById('apiKey').value.trim();
  const headers={'content-type':'application/json','ngrok-skip-browser-warning':'1'};
  if(key) headers['x-api-key']=key;
  const res=await fetch(base+path,{method,headers,body:body?JSON.stringify(body):undefined});
  const text=await res.text();
  log(method+' '+path+' -> '+res.status);
  if(res.ok){
    try{return JSON.parse(text).data;}catch{return null;}
  }else{
    throw new Error(text);
  }
}

function log(msg){
  const pre=document.getElementById('log');
  pre.textContent+=msg+'\n';
  pre.scrollTop=pre.scrollHeight;
}

connect();
</script>
</body>
</html>
