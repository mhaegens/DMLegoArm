<!-- Robot Arm Control v4.0.2 (fix: non-regex join()) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lego Arm Control</title>
  <!-- Tailwind CDN is fine for dev; switch to CLI/PostCSS for production -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: {
      brand: { 25:"#f3f9ff",50:"#eaf3ff",100:"#d6e9ff",200:"#b6d9ff",300:"#8cc5ff",400:"#56aaff",500:"#1f90ff",600:"#1477db",700:"#0f5fb1",800:"#0c4d8f",900:"#0a3e75" }
    }}}};
  </script>
  <style>
    body { background: #f6f9fc; }
    .glass { background: rgba(255,255,255,0.18); border: 1px solid rgba(255,255,255,0.25); box-shadow: 0 8px 24px rgba(0,0,0,0.10); backdrop-filter: saturate(160%) blur(8px); }
    .soft-shadow { box-shadow: 0 14px 32px -8px rgba(2,132,199,.35); }
    .console-area { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="antialiased text-slate-800">
  <div id="root"></div>

  <!-- React prod UMD (JSX handled by Babel for dev iteration) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Optional QR scanner CDN -->
  <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>

  <script type="text/babel">
    const {useEffect,useRef,useState,useMemo} = React;

    // ---------- Utils ----------
    const now = () => Date.now();
    const fmtMs = ms => (ms<1000? ms+'ms' : (ms/1000).toFixed(2)+'s');
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    // Slash-safe join without regex (fixes Babel error in some contexts)
    const join = (a,b) => {
      let s1 = String(a), s2 = String(b);
      while (s1.endsWith('/')) s1 = s1.slice(0,-1);
      while (s2.startsWith('/')) s2 = s2.slice(1);
      return s1 + '/' + s2;
    };
    const MOTOR_ORDER = ["A","B","C","D","E","F"];

    function useLocalStorage(key, initial){
      const [v,setV]=useState(()=>{ try { return JSON.parse(localStorage.getItem(key)) ?? initial; } catch { return initial; } });
      useEffect(()=>{ localStorage.setItem(key, JSON.stringify(v)); }, [key, v]);
      return [v,setV];
    }

    function percentile(arr,p){
      if(arr.length===0) return 0;
      const s=[...arr].sort((a,b)=>a-b);
      const idx = Math.min(s.length-1, Math.max(0, Math.floor((p/100)*(s.length-1))));
      return s[idx];
    }

    // ---------- Small components ----------
    const Icon = ({name, className="w-5 h-5"}) => ({
      menu: <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"/></svg>,
      copy: <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" strokeWidth="2"/><path strokeWidth="2" d="M5 15V5a2 2 0 012-2h10"/></svg>,
      trash:<svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeWidth="2" d="M3 6h18M8 6V4h8v2M6 6l1 14h10l1-14"/></svg>,
      play: <svg className={className} viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>,
      pause:<svg className={className} viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/></svg>,
      plus: <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeWidth="2" d="M12 5v14M5 12h14"/></svg>,
      cam:  <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="5" width="18" height="14" rx="2" strokeWidth="2"/><circle cx="12" cy="12" r="3" strokeWidth="2"/></svg>,
      dl:   <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeWidth="2" d="M12 3v12m0 0l-4-4m4 4l4-4M4 21h16"/></svg>,
      tune: <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeWidth="2" d="M4 6h10M14 6v10M4 18h16M8 18V8M18 6v8"/></svg>,
      target:<svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="8" strokeWidth="2"/><circle cx="12" cy="12" r="2" strokeWidth="2"/></svg>,
    }[name] || <span/>);

    const MotorPill = ({children}) => (
      <div className="glass inline-flex items-center gap-1 px-2 py-1 rounded-full text-white text-[11px]">{children}</div>
    );

    const Sparkline = ({data, width=80, height=20, padding=2}) => {
      if(!data || data.length<2) return <svg width={width} height={height}></svg>;
      const min = Math.min(...data), max = Math.max(...data);
      const range = (max-min) || 1;
      const stepX = (width - 2*padding) / (data.length - 1);
      const pts = data.map((v,i)=>[padding + i*stepX, height - padding - ((v-min)/range)*(height-2*padding)]);
      const d = pts.map((p,i)=> (i===0? 'M':'L') + p[0].toFixed(1)+' '+p[1].toFixed(1)).join(' ');
      return <svg width={width} height={height}><path d={d} fill="none" stroke="currentColor" strokeWidth="1"/></svg>;
    };

    const DeltaGauge = ({delta, tol=1, size=68}) => {
      const r = (size/2)-6, cx=size/2, cy=size/2;
      const clamped = Math.abs(delta) > 90 ? 90 : Math.abs(delta);
      const angle = (clamped/90)*Math.PI;
      const x = cx + r*Math.cos(Math.PI - angle);
      const y = cy + r*Math.sin(Math.PI - angle);
      const path = `M ${cx-r} ${cy} A ${r} ${r} 0 0 1 ${x} ${y}`;
      const ok = Math.abs(delta) <= tol;
      return (
        <svg width={size} height={size} className="text-slate-300">
          <circle cx={cx} cy={cy} r={r} stroke="currentColor" strokeWidth="6" fill="none" opacity="0.25"/>
          <path d={path} stroke={ok?'#10b981':'#ef4444'} strokeWidth="6" fill="none" />
          <text x="50%" y="48%" dominantBaseline="middle" textAnchor="middle" fontSize="14" fill="#0f172a">{delta.toFixed(0)}Â°</text>
          <text x="50%" y="66%" dominantBaseline="middle" textAnchor="middle" fontSize="10" fill="#64748b">Î”</text>
        </svg>
      );
    };

    // ---------- Main App ----------
    function App(){
      const [fleet, setFleet] = useLocalStorage("ra.fleet", [
        { id: 'default', name: 'Robot 1', baseUrl: '', apiKey: '' }
      ]);
      const [currentId, setCurrentId] = useLocalStorage("ra.fleet.current", 'default');

      const current = useMemo(()=>fleet.find(f=>f.id===currentId) || fleet[0], [fleet, currentId]);
      const [baseUrl, setBaseUrl] = useState(current?.baseUrl || '');
      const [apiKey, setApiKey] = useState(current?.apiKey || '');

      const [connected,setConnected]=useState(false);
      const [motors,setMotors]=useLocalStorage("ra.motors",["A","B","C","D"].map((n,i)=>({id:i+1,name:n,pos:0})));
      const [logs,setLogs]=useLocalStorage("ra.logs",[]);
      const [inventory,setInventory]=useState(null);
      const [inventoryOpen,setInventoryOpen]=useState(false);
      const [adminOpen,setAdminOpen]=useState(false);
      const [seqOpen,setSeqOpen]=useState(false);
      const [qrOpen,setQrOpen]=useState(false);

      const RING_MS = 120000;
      const [ring,setRing]=useLocalStorage("ra.ring", []);

      const [limits,setLimits]=useLocalStorage("ra.limits", {A:{min:-180,max:180},B:{min:-180,max:180},C:{min:-180,max:180},D:{min:-180,max:180}});
      const [taught,setTaught]=useLocalStorage("ra.taught", {});
      const [targetPose,setTargetPose]=useLocalStorage("ra.targetPose", null);

      const [sequences,setSequences]=useLocalStorage("ra.sequences", []);
      const [runner,setRunner]=useState({running:false, idx:0, startedAt:0, paused:false});

      const [offlineQueue,setOfflineQueue]=useLocalStorage("ra.offlineQueue", []);

      const [jogMotor,setJogMotor]=useState(null);
      const [jogEnable,setJogEnable]=useState(false);
      const repeatRef = useRef(null);

      const [tiltEnabled,setTiltEnabled]=useState(false);
      const [tiltMotor,setTiltMotor]=useState("A");
      const [tiltGain,setTiltGain]=useState(0.2);

      const [customPath,setCustomPath]=useState("/v1/arm/move");
      const [customMethod,setCustomMethod]=useState("POST");
      const [customBody,setCustomBody]=useState('{"mode":"relative","joints":{"A":10},"speed":40}');
      const [step,setStep]=useLocalStorage("ra.step",5);

      const polling = useRef(false);
      const alive = useRef(true);
      useEffect(()=>()=>{ alive.current=false; },[]);

      useEffect(()=>{
        setFleet(fs => fs.map(f => f.id===currentId ? {...f, baseUrl, apiKey} : f));
      }, [baseUrl, apiKey, currentId, setFleet]);

      const addLog = (e) => {
        const ts = new Date().toLocaleTimeString();
        setLogs(l=>[...l.slice(-999), {ts, ...e}]);
      };

      const headers = () => {
        const h={"Content-Type":"application/json","ngrok-skip-browser-warning":"1"};
        if(apiKey) h["x-api-key"]=apiKey;
        return h;
      };

      async function api(method, path, body, {timeoutMs=8000, queueIfOffline=false}={}){
        if(!baseUrl){ addLog({level:"err",text:"Base URL not set"}); throw new Error("Base URL not set"); }
        const url = join(baseUrl, path);
        if(queueIfOffline && !connected){
          const item={method,path,body,ts:Date.now()}; setOfflineQueue(q=>[...q,item]);
          addLog({level:"ok",text:"Queued (offline): "+method+" "+url, body});
          return null;
        }
        const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
        const opts={method, headers:headers(), signal:ctrl.signal};
        if(body!==undefined) opts.body=JSON.stringify(body);
        addLog({level:"req",text:`${method} ${url}`,body});
        const t0=performance.now();
        try{
          const res=await fetch(url, opts);
          const elapsed=Math.round(performance.now()-t0);
          const txt=await res.text(); let data=null; try{ data = txt ? JSON.parse(txt) : null; } catch {}
          addLog({level:res.ok?"ok":"err", text:`${res.status} ${res.statusText} (${elapsed}ms)`, body:data??txt, ms:elapsed});
          if(!res.ok) throw new Error("HTTP "+res.status);
          return data?.data ?? data;
        } finally { clearTimeout(t); }
      }

      async function runQueue(){
        if(!connected || offlineQueue.length===0) return;
        for(const item of offlineQueue){
          await api(item.method, item.path, item.body).catch(()=>{});
        }
        setOfflineQueue([]);
      }

      async function checkHealth(){
        try{ await api("GET","/v1/health"); setConnected(true); }
        catch{ setConnected(false); }
      }

      async function updatePositions(){
        if(polling.current) return;
        polling.current = true;
        try{
          const s = await api("GET","/v1/arm/state").catch(()=>null);
          if(s?.abs_degrees){
            const ordered = Object.entries(s.abs_degrees)
              .map(([k,v])=>({name:k,pos:+v}))
              .sort((a,b)=>MOTOR_ORDER.indexOf(a.name)-MOTOR_ORDER.indexOf(b.name))
              .map((m,i)=>({id:i+1,...m}));
            setMotors(ordered);
            const sample = { t: Date.now(), angles: Object.fromEntries(ordered.map(m=>[m.name, m.pos])) };
            setRing(prev => {
              const arr = [...prev, sample];
              const cutoff = Date.now() - RING_MS;
              return arr.filter(s => s.t >= cutoff);
            });
          }
        } finally { polling.current=false; }
      }

      async function loadInventory(show=false){
        const inv = await api("GET","/v1/inventory").catch(()=>null);
        if(show && inv){ setInventory(inv); setInventoryOpen(true); }
        return inv;
      }

      async function sendPose(name, speed=60){
        if(!name) return;
        await api("POST","/v1/arm/pose", {name, speed}, {queueIfOffline:true});
      }

      async function stop(){ await api("POST","/v1/arm/stop",{reason:"ui stop"},{queueIfOffline:true}).catch(()=>{}); }

      async function nudge(name, delta, speed=60){
        const cur = motors.find(m=>m.name===name)?.pos ?? 0;
        const lim = limits[name] || {min:-9999,max:9999};
        const next = cur + delta;
        if(next < lim.min || next > lim.max){
          addLog({level:"err", text:`Soft limit ${name}: ${next.toFixed(1)}Â° out of [${lim.min}, ${lim.max}]`});
          return;
        }
        const joints={}; joints[name]=delta;
        await api("POST","/v1/arm/move",{mode:"relative",joints,speed},{queueIfOffline:true}).catch(()=>{});
        setMotors(p=>p.map(x=>x.name===name?{...x,pos:x.pos+delta}:x));
      }

      async function refresh(){ await updatePositions(); }

      useEffect(()=>{ checkHealth(); const id=setInterval(checkHealth,15000); return ()=>clearInterval(id); }, [baseUrl, apiKey]);
      useEffect(()=>{
        if(!baseUrl) return;
        updatePositions();
        const id=setInterval(()=>{ if(!document.hidden) updatePositions(); }, 5000);
        const onVis = () => { if(!document.hidden) updatePositions(); };
        document.addEventListener("visibilitychange", onVis);
        return ()=>{ clearInterval(id); document.removeEventListener("visibilitychange", onVis); };
      }, [baseUrl, apiKey]);

      const series = useMemo(()=>{
        const names = Object.keys(motors.reduce((acc,m)=> (acc[m.name]=1, acc), {}));
        const byName = Object.fromEntries(names.map(n=>[n, []]));
        ring.forEach(s=>{ names.forEach(n=> byName[n].push({t:s.t, v: s.angles[n] ?? 0})) });
        return byName;
      }, [ring, motors]);

      const rates = useMemo(()=>{
        const r={};
        for(const [n,arr] of Object.entries(series)){
          if(arr.length<2){ r[n]=0; continue; }
          const a=arr[arr.length-2], b=arr[arr.length-1];
          const dt=(b.t-a.t)/1000; const dv=b.v-a.v; r[n]= dt? (dv/dt) : 0;
        }
        return r;
      }, [series]);

      const latencies = useMemo(()=> logs.filter(l=>typeof l.ms==='number').map(l=>l.ms), [logs]);
      const reliab = useMemo(()=>{
        const ok = logs.filter(l=>l.level==='ok').length;
        const err = logs.filter(l=>l.level==='err').length;
        const total = ok+err || 1;
        return { successRate: (ok/total)*100, p50: percentile(latencies, 50), p95: percentile(latencies, 95) };
      }, [logs, latencies]);

      const bins = useMemo(()=>{
        const B=18;
        const out={};
        for(const n of Object.keys(series)){
          const arr=new Array(B).fill(0);
          const values = series[n].map(x=>x.v);
          if(values.length){
            const min=Math.min(...values), max=Math.max(...values);
            const denom = (max-min) || 1;
            for(const v of values){
              const idx = Math.max(0, Math.min(B-1, Math.floor(((v-min)/denom) * (B-1))));
              arr[idx]++;
            }
          }
          out[n]=arr;
        }
        return out;
      }, [series]);

      const targetAngles = useMemo(()=>{
        if(targetPose && taught[targetPose]) return taught[targetPose];
        return null;
      }, [targetPose, taught]);

      function startRepeat(name, delta){
        if(!jogEnable) return;
        if(repeatRef.current) return;
        nudge(name, delta);
        repeatRef.current = setInterval(()=> nudge(name, delta), 220);
      }
      function stopRepeat(){ if(repeatRef.current){ clearInterval(repeatRef.current); repeatRef.current=null; } }

      async function runSequence(seq){
        setRunner({running:true, idx:0, startedAt:Date.now(), paused:false});
        for(let i=0;i<seq.steps.length;i++){
          if(!alive.current) break;
          if(runner.paused){ await new Promise(res=>{ const iv=setInterval(()=>{ if(!runner.paused){ clearInterval(iv); res(); } }, 200); }); }
          const step=seq.steps[i];
          if(step.type==='pose'){ await sendPose(step.name, step.speed||60); }
          if(step.type==='move'){ await api("POST","/v1/arm/move",{mode:"relative", joints: step.joints, speed: step.speed||60}).catch(()=>{}); }
          if(step.type==='wait'){ await new Promise(res=>setTimeout(res, step.ms||500)); }
          if(step.type==='stop'){ await stop(); }
          setRunner(r=>({...r, idx:i+1}));
        }
        setRunner(r=>({...r, running:false}));
      }

      function dryRun(seq){
        let ms=0;
        for(const s of seq.steps){
          if(s.type==='wait') ms += s.ms||500;
          if(s.type==='move'){
            const total = Object.values(s.joints||{}).reduce((a,b)=>a+Math.abs(b),0);
            ms += (total * (1000/(s.speed||60)));
          }
          if(s.type==='pose') ms += 700;
        }
        alert("Estimated duration: "+fmtMs(ms));
      }

      function blendToPose(percent, speed=60){
        if(!targetAngles) return;
        const joints={};
        for(const m of motors){
          const tgt = targetAngles[m.name];
          if(typeof tgt !== 'number') continue;
          const delta = (tgt - m.pos) * (percent/100);
          if(Math.abs(delta)>=0.5) joints[m.name]=Math.round(delta);
        }
        if(Object.keys(joints).length){
          api("POST","/v1/arm/move",{mode:"relative", joints, speed}).catch(()=>{});
        }
      }

      async function runTuner({joint="A", amplitude=5, speeds=[20,40,60,80], settleMs=350}){
        const results=[];
        for(const sp of speeds){
          const before = motors.find(m=>m.name===joint)?.pos ?? 0;
          await nudge(joint, amplitude, sp);
          await new Promise(res=>setTimeout(res, settleMs));
          await refresh();
          const peak = motors.find(m=>m.name===joint)?.pos ?? before;
          await nudge(joint, -amplitude, sp);
          await new Promise(res=>setTimeout(res, settleMs));
          await refresh();
          const after = motors.find(m=>m.name===joint)?.pos ?? before;
          const forwardErr = Math.abs((before+amplitude) - peak);
          const returnErr  = Math.abs(before - after);
          results.push({speed:sp, forwardErr, returnErr});
        }
        return results;
      }

      function exportDiagnostics(){
        const blob = new Blob([JSON.stringify({
          ts: new Date().toISOString(),
          fleet, currentId, baseUrl,
          inventory,
          motors,
          ring,
          limits,
          taught,
          sequences,
          logs: logs.slice(-200),
        }, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href=url; a.download = 'robot_diagnostics.json';
        a.click();
        URL.revokeObjectURL(url);
      }

      function parseQr(text){
        try {
          const j = JSON.parse(text);
          if(j.baseUrl) setBaseUrl(j.baseUrl);
          if(j.apiKey) setApiKey(j.apiKey);
          return;
        } catch {}
        const params = new URLSearchParams(text);
        if(params.get('baseUrl')) setBaseUrl(params.get('baseUrl'));
        if(params.get('apiKey')) setApiKey(params.get('apiKey'));
      }

      useEffect(()=>{
        if(!tiltEnabled) return;
        function onOrient(e){
          const beta = e.beta || 0;
          const delta = clamp(beta * tiltGain, -2, 2);
          if(Math.abs(delta) > 0.2) nudge(tiltMotor, Math.sign(delta));
        }
        window.addEventListener('deviceorientation', onOrient);
        return ()=> window.removeEventListener('deviceorientation', onOrient);
      }, [tiltEnabled, tiltMotor, tiltGain, motors]);

      const StatusPill = () => (
        <div className={"inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white text-slate-800 shadow-sm ring-1 " + (connected ? 'ring-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.6)]' : 'ring-slate-200')}>
          <span className={"w-2.5 h-2.5 rounded-full " + (connected ? 'bg-emerald-400 shadow-[0_0_6px_rgba(52,211,153,0.8)]' : 'bg-slate-300')}></span>
          <span className="font-semibold">{connected ? "Connected" : "Offline"}</span>
        </div>
      );

      return (
        <div className="min-h-screen relative">
          <header className="relative bg-gradient-to-b from-brand-600 to-brand-700 text-white soft-shadow overflow-visible">
            <div className="max-w-6xl mx-auto px-4 sm:px-6 pt-4">
              <div className="flex items-center justify-between gap-2">
                <div className="flex items-center gap-3">
                  <h1 className="text-2xl font-semibold tracking-tight drop-shadow-sm">Lego Arm Control</h1>
                  <select className="px-2 py-1 rounded-lg bg-white/10 border border-white/30" value={currentId} onChange={e=>setCurrentId(e.target.value)}>
                    {fleet.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                  </select>
                  <button className="px-2 py-1 rounded-lg bg-white/10 border border-white/30" onClick={()=>{
                    const name=prompt("Robot name?"); if(!name) return;
                    const id='r'+Math.random().toString(36).slice(2,7);
                    setFleet([...fleet, {id, name, baseUrl:'', apiKey:''}]);
                    setCurrentId(id);
                  }}>+ Add</button>
                </div>
                <div className="flex items-center gap-2">
                  <button className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/30 text-white flex items-center gap-2" onClick={()=>setQrOpen(true)} title="Scan QR for config">ðŸ“· QR</button>
                  <button className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/30 text-white flex items-center gap-2" onClick={()=>setAdminOpen(true)} aria-label="Open admin settings">â˜° Admin</button>
                </div>
              </div>
            </div>

            <div className="relative max-w-6xl mx-auto px-4 sm:px-6 h-[18rem] sm:h-[22rem]">
              <img src="robot-arm.png" alt="Robot Arm" className="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-[20%] pointer-events-none select-none max-h-[20rem] sm:max-h-[24rem] drop-shadow-[0_16px_36px_rgba(31,144,255,0.55)]" />
              <div className="absolute right-4 sm:right-6 top-1/2 -translate-y-1/2 flex flex-col gap-2 items-end">
                {motors.map(m => (
                  <div key={m.id} className="glass inline-flex items-center gap-1 px-2 py-1 rounded-full text-white text-[11px]">
                    <span className="font-semibold">{m.name}</span>
                    <span className="opacity-90 ml-0.5">{Math.round(m.pos)}Â°</span>
                    <button className="ml-1 px-1 py-0.5 rounded bg-white/20 hover:bg-white/30" title="Jog" onClick={()=>setJogMotor(m)}>J</button>
                  </div>
                ))}
              </div>
            </div>
          </header>

          <div className="max-w-6xl mx-auto px-4 sm:px-6 mt-6 relative z-10 flex items-center gap-3">
            <StatusPill />
            {offlineQueue.length>0 && connected && (
              <button className="px-3 py-1.5 rounded-lg bg-amber-100 text-amber-900 border border-amber-300" onClick={runQueue}>
                Execute queued ({offlineQueue.length})
              </button>
            )}
          </div>

          <main className="max-w-6xl mx-auto px-4 sm:px-6 pt-12 sm:pt-16 pb-20 space-y-6">
            <section className="bg-white rounded-2xl shadow ring-1 ring-slate-100 p-4 sm:p-6">
              <div className="flex items-center justify-between">
                <h2 className="text-slate-800 font-semibold">General</h2>
                <div className="text-xs text-slate-500">Quick actions</div>
              </div>
              <div className="mt-4 grid sm:grid-cols-5 gap-3">
                <button className="px-3 py-2.5 rounded-xl bg-brand-600 hover:bg-brand-700 text-white" onClick={()=>sendPose("home")}>Home</button>
                <button className="px-3 py-2.5 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-slate-700" onClick={stop}>Stop</button>
                <button className="px-3 py-2.5 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-slate-700" onClick={()=>checkHealth()}>Health</button>
                <button className="px-3 py-2.5 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-slate-700" onClick={()=>loadInventory(true)}>Inventory</button>
                <button className="px-3 py-2.5 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-slate-700" onClick={()=>refresh()}>Refresh positions</button>
              </div>
            </section>

            <!-- (The rest of the sections are identical to v4.0.1; omitted here for brevity in this code block)
                 Your downloaded file includes the full content, unchanged except for join(). -->

          </main>

          <footer className="py-6 text-center text-xs text-slate-500">Built with React + Tailwind. Settings are saved in your browser.</footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
