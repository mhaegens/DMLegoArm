<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LEGO Arm Control</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/dist/tailwind.min.css" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script>
    const { useState, useEffect, useRef } = React;
    const e = React.createElement;

    function App(){
      const [apiKey, setApiKey] = useState('');
      const defaultBase = window.location.origin.startsWith('http') ? '' : 'http://localhost:8000';
      const [base, setBase] = useState(defaultBase);
      const [status, setStatus] = useState('Disconnected');
      const [positions, setPositions] = useState({});
      const [log, setLog] = useState('');
      const [motor, setMotor] = useState('A');
      const [step, setStep] = useState(5);
      const poller = useRef(null);

      const addLog = msg => {
        setLog(l => (l + msg + '\n').slice(-4000));
      };

      const api = async (method, path, body) => {
        const headers = {'content-type':'application/json','ngrok-skip-browser-warning':'1'};
        if(apiKey) headers['x-api-key']=apiKey;
        const res = await fetch(base + path, {method, headers, body: body? JSON.stringify(body):undefined});
        addLog(method+' '+path+' -> '+res.status);
        if(!res.ok) throw new Error(await res.text());
        const text = await res.text();
        try{ return JSON.parse(text).data; }catch(e){ return null; }
      };

      const getState = async () => {
        try{
          const data = await api('GET','/v1/arm/state');
          setStatus('Connected');
          setPositions(data.abs_degrees || {});
        }catch(e){
          setStatus('Error');
        }
      };

      const connect = () => {
        getState();
        if(poller.current) clearInterval(poller.current);
        poller.current = setInterval(getState, 2000);
      };

      const health = () => api('GET','/v1/health');
      const inventory = () => api('GET','/v1/inventory');
      const home = () => api('POST','/v1/arm/pose',{name:'home',speed:60});
      const stop = () => api('POST','/v1/arm/stop',{reason:'ui stop'});
      const nudge = dir => {
        const s = parseFloat(step);
        if(!s) return;
        const sign = (dir==='left'||dir==='up')?-1:1;
        const joints={}; joints[motor]=sign*s;
        return api('POST','/v1/arm/move',{mode:'relative',joints,speed:60}).then(getState);
      };

      useEffect(()=>{connect(); return ()=>poller.current && clearInterval(poller.current);},[]);

      const positionElems = Object.entries(positions).map(([k,v]) =>
        e('div', {key:k, className:'bg-white/20 rounded-full px-3 py-1 text-center text-sm'}, `${k}: ${v.toFixed(1)}°`)
      );
      const motorOptions = ['A','B','C','D'].map(m => e('option',{key:m,value:m},m));

      return e('div',{className:'min-h-screen flex flex-col'},
        e('header',{className:'bg-blue-600 text-white'},
          e('div',{className:'max-w-5xl mx-auto p-4 flex flex-col items-center'},
            e('div',{className:'w-full flex justify-between mb-4'},
              e('div',{className:'px-4 py-1 rounded-full bg-white/20'}, status),
              e('div',{className:'px-4 py-1 rounded-full bg-white/20'}, `Motors ${Object.keys(positions).length? 'OK':'--'}`)
            ),
            e('img',{src:'robot-arm.png',alt:'Robot arm',className:'h-40 object-contain'}),
            e('div',{className:'mt-4 grid grid-cols-2 sm:grid-cols-4 gap-2 w-full'}, positionElems)
          )
        ),
        e('main',{className:'flex-1 bg-gray-50'},
          e('div',{className:'max-w-5xl mx-auto p-4 space-y-4'},
            e('section',{className:'bg-white rounded-xl shadow p-6'},
              e('h2',{className:'text-lg font-semibold text-blue-600 mb-4'},'General Commands'),
              e('div',{className:'grid sm:grid-cols-2 gap-4'},
                e('label',{className:'text-sm font-medium'},'API Key',
                  e('input',{type:'password',value:apiKey,onChange:e=>setApiKey(e.target.value),className:'mt-1 w-full border rounded p-2'})
                ),
                e('label',{className:'text-sm font-medium'},'Base URL',
                  e('input',{value:base,onChange:e=>setBase(e.target.value),className:'mt-1 w-full border rounded p-2'})
                )
              ),
              e('div',{className:'flex flex-wrap gap-2 mt-4'},
                e('button',{onClick:connect,className:'bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700'},'Connect'),
                e('button',{onClick:health,className:'bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700'},'Health'),
                e('button',{onClick:inventory,className:'bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700'},'Inventory'),
                e('button',{onClick:home,className:'bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700'},'Home'),
                e('button',{onClick:stop,className:'bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700'},'Stop')
              )
            ),
            e('section',{className:'bg-white rounded-xl shadow p-6'},
              e('h2',{className:'text-lg font-semibold text-blue-600 mb-4'},'Console'),
              e('pre',{className:'bg-black text-green-400 rounded p-3 h-40 overflow-auto whitespace-pre-wrap'}, log)
            ),
            e('section',{className:'bg-white rounded-xl shadow p-6'},
              e('h2',{className:'text-lg font-semibold text-blue-600 mb-4'},'Nudge Controls'),
              e('div',{className:'flex flex-wrap gap-4 mb-4'},
                e('label',{className:'text-sm font-medium'},'Motor',
                  e('select',{value:motor,onChange:e=>setMotor(e.target.value),className:'mt-1 border rounded p-2'}, motorOptions)
                ),
                e('label',{className:'text-sm font-medium'},'Step (°)',
                  e('input',{type:'number',value:step,onChange:e=>setStep(e.target.value),className:'mt-1 w-24 border rounded p-2'})
                )
              ),
              e('div',{className:'grid grid-cols-3 grid-rows-3 gap-3 w-32 mx-auto'},
                e('button',{onClick:()=>nudge('up'),className:'col-start-2 row-start-1 w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 active:bg-gray-400 flex items-center justify-center'},'▲'),
                e('button',{onClick:()=>nudge('left'),className:'col-start-1 row-start-2 w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 active:bg-gray-400 flex items-center justify-center'},'◀'),
                e('button',{onClick:()=>nudge('right'),className:'col-start-3 row-start-2 w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 active:bg-gray-400 flex items-center justify-center'},'▶'),
                e('button',{onClick:()=>nudge('down'),className:'col-start-2 row-start-3 w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 active:bg-gray-400 flex items-center justify-center'},'▼')
              )
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(e(App));
  </script>
</body>
</html>
