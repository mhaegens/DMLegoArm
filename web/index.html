<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>LEGO Arm Control</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--primary:#0a6ed1;--bg:#f5f6f7;--card:#fff;--text:#32363a}
*{box-sizing:border-box}
body{font-family:"Inter",Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
header{background:var(--primary);color:#fff;padding:16px 24px;font-size:20px;font-weight:600;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
main{max-width:1000px;margin:24px auto;padding:0 24px 24px;display:grid;gap:24px}
section{background:var(--card);padding:24px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
section h2{margin-top:0;font-size:18px;border-bottom:1px solid #e5e7eb;padding-bottom:8px;margin-bottom:16px}
label{display:block;margin-top:8px}
input,button{padding:8px 12px;font-size:14px;margin-top:4px;border:1px solid #d1d5db;border-radius:4px}
button{background:var(--primary);border:none;color:#fff;border-radius:4px;cursor:pointer;transition:background 0.2s;margin-right:8px}
button:hover{background:#0859a6}
button:disabled{background:#9ca3af}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
pre{background:#111;color:#0f0;padding:12px;overflow:auto;border-radius:4px;height:200px}
#stateTable th{text-align:left;padding-right:8px}
</style>
</head>
<body>
<header>LEGO Arm Control</header>
<main>
<section id="auth" class="grid">
<label>API Key <input type="password" id="apiKey"></label>
<label>Base URL <input id="base" placeholder="http://localhost:8000"></label>
<div style="align-self:end"><button onclick="connect()">Connect</button></div>
</section>

<section id="status">
<h2>Status</h2>
<div id="statusText">Not connected.</div>
<table id="stateTable"></table>
</section>

<section>
<h2>Poses</h2>
<div class="grid">
<button onclick="pose('home')">Home</button>
<button onclick="pose('pick_left')">Pick Left</button>
<button onclick="pose('pick_right')">Pick Right</button>
<button onclick="pose('place_left')">Place Left</button>
<button onclick="pose('place_right')">Place Right</button>
</div>
</section>

<section>
<h2>Custom Move</h2>
<div class="grid">
<label>Joint A <input id="jointA" type="number" value="0"></label>
<label>Joint B <input id="jointB" type="number" value="0"></label>
<label>Joint C <input id="jointC" type="number" value="0"></label>
<label>Joint D <input id="jointD" type="number" value="0"></label>
<label>Speed <input id="speed" type="number" value="60"></label>
<div style="align-self:end"><button onclick="move()">Move</button></div>
</div>
</section>

<section>
<h2>Emergency</h2>
<button onclick="stop()">Stop</button>
</section>

<section>
<h2>Log</h2>
<pre id="log"></pre>
</section>
</main>
<script>
let poller;

function connect(){
  const base=document.getElementById('base').value.trim()||window.location.origin;
  document.getElementById('base').value=base;
  log('Base set to '+base);
  clearInterval(poller);
  poller=setInterval(()=>refreshState(base),2000);
  refreshState(base);
}

async function refreshState(base){
  try{
    const data=await api(base,'GET','/v1/arm/state');
    document.getElementById('statusText').textContent='OK';
    const t=document.getElementById('stateTable');
    t.innerHTML='';
    for(const [k,v] of Object.entries(data.abs_degrees)){
      const row=document.createElement('tr');
      row.innerHTML=`<th>${k}</th><td>${v.toFixed(1)}Â°</td>`;
      t.appendChild(row);
    }
  }catch(e){
    document.getElementById('statusText').textContent='Error';
  }
}

async function pose(name){
  const base=document.getElementById('base').value.trim()||window.location.origin;
  await api(base,'POST','/v1/arm/pose',{name,speed:60});
  refreshState(base);
}

async function move(){
  const base=document.getElementById('base').value.trim()||window.location.origin;
  const joints={};
  ['A','B','C','D'].forEach(j=>{
    const val=parseFloat(document.getElementById('joint'+j).value);
    if(val) joints[j]=val;
  });
  await api(base,'POST','/v1/arm/move',{mode:'relative',joints,speed:parseInt(document.getElementById('speed').value||'60')});
  refreshState(base);
}

async function stop(){
  const base=document.getElementById('base').value.trim()||window.location.origin;
  await api(base,'POST','/v1/arm/stop',{reason:'ui stop'});
}

async function api(base,method,path,body){
  const key=document.getElementById('apiKey').value.trim();
  const headers={'content-type':'application/json','ngrok-skip-browser-warning':'1'};
  if(key) headers['x-api-key']=key;
  const res=await fetch(base+path,{method,headers,body:body?JSON.stringify(body):undefined});
  const text=await res.text();
  log(method+' '+path+' -> '+res.status);
  if(res.ok){
    try{return JSON.parse(text).data;}catch{return null;}
  }else{
    throw new Error(text);
  }
}

function log(msg){
  const pre=document.getElementById('log');
  pre.textContent+=msg+'\n';
  pre.scrollTop=pre.scrollHeight;
}

connect();
</script>
</body>
</html>
