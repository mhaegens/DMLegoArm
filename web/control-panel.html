<!-- Robot Arm Control v3.5 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lego Arm Control</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 25:"#f3f9ff",50:"#eaf3ff",100:"#d6e9ff",200:"#b6d9ff",300:"#8cc5ff",400:"#56aaff",500:"#1f90ff",600:"#1477db",700:"#0f5fb1",800:"#0c4d8f",900:"#0a3e75" }
          }
        }
      }
    }
  </script>
  <style>
    body { background: #f6f9fc; }
    .glass { background: rgba(255,255,255,0.18); border: 1px solid rgba(255,255,255,0.25); box-shadow: 0 8px 24px rgba(0,0,0,0.10); backdrop-filter: saturate(160%) blur(8px); }
    .soft-shadow { box-shadow: 0 14px 32px -8px rgba(2,132,199,.35); }
    .console-area { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="antialiased text-slate-800">
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>


  <script type="text/babel">
    const {useEffect,useRef,useState} = React;
    const Icon=({name,className="w-5 h-5"})=>({menu:<svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"/></svg>,copy:<svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" strokeWidth="2"/><path strokeWidth="2" d="M5 15V5a2 2 0 012-2h10"/></svg>,trash:<svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeWidth="2" d="M3 6h18M8 6V4h8v2M6 6l1 14h10l1-14"/></svg>}[name]||<span/>);

    function useLocalStorage(key, initial){
      const [v,setV]=useState(()=>{try{return JSON.parse(localStorage.getItem(key))??initial;}catch{return initial;}});
      useEffect(()=>{localStorage.setItem(key,JSON.stringify(v));},[key,v]);
      return [v,setV];
    }
    const defaultMotors=['A','B','C','D'].map((name,i)=>({id:i+1,name,pos:0}));

    function App(){
      const [baseUrl,setBaseUrl]=useLocalStorage("ra.baseUrl","");
      const [apiKey,setApiKey]=useLocalStorage("ra.apiKey","");
      const [connected,setConnected]=useState(false);
      const [motors,setMotors]=useLocalStorage("ra.motors",defaultMotors);
      const [logs,setLogs]=useLocalStorage("ra.logs",[]);
      const [step,setStep]=useLocalStorage("ra.step",5);
      const [poseName,setPoseName]=useState("");
      const [customPath,setCustomPath]=useState("/v1/arm/move");
      const [customMethod,setCustomMethod]=useState("POST");
      const [customBody,setCustomBody]=useState('{"mode":"relative","joints":{"A":10},"speed":40}');
      const [adminOpen,setAdminOpen]=useState(false);
      const [inventory,setInventory]=useState(null);
      const [inventoryOpen,setInventoryOpen]=useState(false);
      const logRef=useRef(null);
      useEffect(()=>{if(logRef.current)logRef.current.scrollTop=logRef.current.scrollHeight;},[logs]);

      function addLog(e){const ts=new Date().toLocaleTimeString();setLogs(l=>[...l.slice(-999),{ts,...e}]);}
      function headers(){const h={"Content-Type":"application/json","ngrok-skip-browser-warning":"1"};if(apiKey)h["x-api-key"]=apiKey;return h;}
      async function api(method,path,body){
        if(!baseUrl){addLog({level:"err",text:"Base URL not set"});throw new Error("Base URL not set");}
        const url=baseUrl.replace(/\/$/,"")+path;
        const opts={method,headers:headers()};
        if(body!==undefined)opts.body=JSON.stringify(body);
        addLog({level:"req",text:method+" "+url,body});
        const t0=performance.now();
        try{
          const res=await fetch(url,opts);
          const elapsed=Math.round(performance.now()-t0);
          const txt=await res.text();
          let data=null;try{data=txt?JSON.parse(txt):null;}catch{}
          addLog({level:res.ok?"ok":"err",text:res.status+" "+res.statusText+" ("+elapsed+"ms)",body:data??txt});
          if(!res.ok)throw new Error("HTTP "+res.status);
          return data?.data??data;
        }catch(e){addLog({level:"err",text:String(e.message||e)});throw e;}
      }
      async function checkHealth(){try{await api("GET","/v1/health");setConnected(true);}catch{setConnected(false);}}
      async function loadInventory(show=false){const inv=await api("GET","/v1/inventory").catch(()=>null);const s=await api("GET","/v1/arm/state").catch(()=>null);if(s?.abs_degrees){const mapped=Object.entries(s.abs_degrees).map(([k,v],i)=>({id:i+1,name:k,pos:Math.round(v)}));setMotors(mapped);}if(show && inv){setInventory(inv);setInventoryOpen(true);}return inv;}
      async function showInventory(){await loadInventory(true);}
      async function sendPose(n){if(!n)return;await api("POST","/v1/arm/pose",{name:n,speed:60});await loadInventory();}
      async function home(){await sendPose("home");}
      async function stop(){await api("POST","/v1/arm/stop",{reason:"ui stop"}).catch(()=>{});}
      async function refreshPositions(){await loadInventory(false);}
      async function nudge(m,d){const name=m.name||("M"+m.id);const joints={};joints[name]=d;await api("POST","/v1/arm/move",{mode:"relative",joints,speed:60}).catch(()=>{});setMotors(p=>p.map(x=>x.id===m.id?{...x,pos:x.pos+d}:x));}
      async function runCustom(){let body;try{body=customBody?JSON.parse(customBody):undefined;}catch{alert("Invalid JSON body");return;}await api(customMethod,customPath,body);}

      useEffect(()=>{checkHealth();const id=setInterval(checkHealth,15000);return()=>clearInterval(id);},[baseUrl,apiKey]);

      // Compact pill variants
      const MotorPill=({children})=>(<div className="glass inline-flex items-center gap-1 px-2 py-1 rounded-full text-white text-[11px]">{children}</div>);

      return (
        <div className="min-h-screen relative">
          {/* Header */}
          <header className="relative bg-gradient-to-b from-brand-600 to-brand-700 text-white soft-shadow overflow-visible">
            <div className="max-w-6xl mx-auto px-4 sm:px-6 pt-4">
              {/* Top bar: title left, admin right */}
              <div className="flex items-center justify-between">
                <h1 className="text-2xl font-semibold tracking-tight drop-shadow-sm">Lego Arm Control</h1>
                <button className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/30 text-white flex items-center gap-2" onClick={()=>setAdminOpen(true)}>
                  <Icon name="menu" /><span>Admin</span>
                </button>
              </div>
            </div>

            {/* Hero + right-side stacked motor pills with overlap */}
            <div className="relative max-w-6xl mx-auto px-4 sm:px-6 h-[18rem] sm:h-[22rem]">
              <img src="robot-arm.png" alt="Robot Arm"
                   className="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-[20%] pointer-events-none select-none max-h-[20rem] sm:max-h-[24rem] drop-shadow-[0_16px_36px_rgba(31,144,255,0.55)]" />
              {/* Stacked M1..M4 */}
              <div className="absolute right-4 sm:right-6 top-1/2 -translate-y-1/2 flex flex-col gap-2 items-end">
                {motors.map(m => (
                  <MotorPill key={m.id}><span className="font-semibold">{m.name}</span><span className="opacity-90 ml-0.5">{m.pos}&deg;</span></MotorPill>
                ))}
              </div>
            </div>
          </header>

          {/* Overall status pill: light background + dark text for legibility */}
          <div className="max-w-6xl mx-auto px-4 sm:px-6 mt-6 relative z-10">
            <div className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white text-slate-800 shadow-sm ring-1 ${connected ? 'ring-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.6)]' : 'ring-slate-200'}`}>
              <span className="text-[11px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full">Link</span>
              <span className="font-semibold">{connected ? "Connected" : "Offline"}</span>
            </div>
          </div>

          {/* Main content */}
          <main className="max-w-6xl mx-auto px-4 sm:px-6 pt-12 sm:pt-16 pb-16">
            {/* General commands */}
            <section className="bg-white rounded-2xl shadow ring-1 ring-slate-100 p-4 sm:p-6">
              <div className="flex items-center justify-between">
                <h2 className="text-slate-800 font-semibold">General commands</h2>
                <div className="text-xs text-slate-500">Quick actions</div>
              </div>
              <div className="mt-4 grid sm:grid-cols-4 gap-3">
                <button className="px-3 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white" onClick={home}>Home</button>
                <button className="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-slate-700" onClick={stop}>Stop</button>
                <button className="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-slate-700" onClick={checkHealth}>Health</button>
                <button className="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-slate-700" onClick={showInventory}>Inventory</button>
              </div>

              <div className="mt-6 grid md:grid-cols-3 gap-4">
                <div className="md:col-span-2">
                  <div className="grid sm:grid-cols-3 gap-3">
                    <div className="sm:col-span-2">
                      <label className="block text-xs text-slate-600 mb-1">Pose name</label>
                      <input className="w-full px-3 py-2 rounded-xl bg-white border border-slate-200 shadow-inner" placeholder="e.g. pick_left" value={poseName} onChange={e=>setPoseName(e.target.value)} />
                    </div>
                    <div className="flex items-end">
                      <button className="w-full px-3 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white" onClick={()=>sendPose(poseName)}>Go to pose</button>
                    </div>
                  </div>
                </div>
                <div className="border border-dashed rounded-xl p-3">
                  <div className="text-xs text-slate-600 mb-2">Tips</div>
                  <ul className="text-xs text-slate-600 space-y-1 list-disc list-inside">
                    <li>Use Inventory to refresh motor positions.</li>
                    <li>Base URL should be your exposed API root.</li>
                    <li>Auth headers are optional and saved locally.</li>
                  </ul>
                </div>
              </div>

            </section>

            {/* Console */}
            <section className="bg-white rounded-2xl shadow ring-1 ring-slate-100 p-4 sm:p-6 mt-6">
              <div className="flex items-center justify-between">
                <h2 className="text-slate-800 font-semibold">Console</h2>
                <div className="flex gap-2">
                  <button className="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-slate-700" onClick={()=>navigator.clipboard.writeText(JSON.stringify(logs,null,2))}><Icon name="copy" /><span className="ml-1">Copy</span></button>
                  <button className="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-slate-700" onClick={()=>setLogs([])}><Icon name="trash" /><span className="ml-1">Clear</span></button>
                </div>
              </div>
              <div ref={logRef} className="console-area mt-3 bg-slate-950 text-slate-100 rounded-xl p-3 h-64 overflow-auto ring-1 ring-black/10">
                {logs.length === 0 && <div className="text-slate-400">No logs yet. Actions will appear here.</div>}
                {logs.map((l, idx) => (
                  <div key={idx} className="whitespace-pre-wrap text-sm">
                    <span className="text-brand-300">{l.ts}</span>{" "}
                    <span className={{"req":"text-sky-300","ok":"text-emerald-300","err":"text-red-300"}[l.level] || ""}>{l.text}</span>
                    {l.body !== undefined && <pre className="text-xs text-slate-300 mt-1 mb-2 bg-slate-900/60 rounded p-2">{typeof l.body === "string" ? l.body : JSON.stringify(l.body, null, 2)}</pre>}
                  </div>
                ))}
              </div>
            </section>

            {/* Nudge controls */}
            <section className="bg-white rounded-2xl shadow ring-1 ring-slate-100 p-4 sm:p-6 mt-6">
              <div className="flex items-center justify-between">
                <h2 className="text-slate-800 font-semibold">Nudge controls</h2>
                <div className="flex items-center gap-2">
                  <span className="text-xs text-slate-600">Step</span>
                  <select className="px-3 py-2 rounded-xl bg-white border border-slate-200" value={step} onChange={e=>setStep(parseInt(e.target.value)||1)}>
                    <option value="1">1&deg;</option>
                    <option value="2">2&deg;</option>
                    <option value="5">5&deg;</option>
                    <option value="10">10&deg;</option>
                  </select>
                </div>
              </div>
              <div className="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {motors.map(m => (
                  <div key={m.id} className="border rounded-xl p-4">
                    <div className="flex items-center justify-between">
                      <div className="font-semibold">{m.name}</div>
                      <div className="text-sm text-slate-500">{m.pos}&deg;</div>
                    </div>
                    <div className="mt-3 flex gap-2">
                      <button className="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-slate-700 w-full" onClick={()=>nudge(m,-step)}>-{step}&deg;</button>
                      <button className="px-3 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white w-full" onClick={()=>nudge(m, step)}>+{step}&deg;</button>
                    </div>
                  </div>
                ))}
              </div>
            </section>

            {/* Custom request */}
            <section className="bg-white rounded-2xl shadow ring-1 ring-slate-100 p-4 sm:p-6 mt-6">
              <div className="flex items-center justify-between">
                <h2 className="text-slate-800 font-semibold">Custom request</h2>
              </div>
              <div className="mt-4 grid sm:grid-cols-5 gap-3">
                <div>
                  <label className="block text-xs text-slate-600 mb-1">Method</label>
                  <select className="w-full px-3 py-2 rounded-xl bg-white border border-slate-200" value={customMethod} onChange={e=>setCustomMethod(e.target.value)}>
                    <option>GET</option><option>POST</option><option>PUT</option><option>PATCH</option><option>DELETE</option>
                  </select>
                </div>
                <div className="sm:col-span-2">
                  <label className="block text-xs text-slate-600 mb-1">Path</label>
                  <input className="w-full px-3 py-2 rounded-xl bg-white border border-slate-200" value={customPath} onChange={e=>setCustomPath(e.target.value)} />
                </div>
                <div className="sm:col-span-2">
                  <label className="block text-xs text-slate-600 mb-1">JSON body</label>
                  <textarea className="w-full px-3 py-2 rounded-xl bg-white border border-slate-200 h-[42px]" value={customBody} onChange={e=>setCustomBody(e.target.value)}></textarea>
                </div>
              </div>
              <div className="mt-3 flex gap-2">
                <button className="px-3 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white" onClick={runCustom}>Send</button>
                <button className="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-slate-700" onClick={refreshPositions}>Refresh positions</button>
              </div>
            </section>
          </main>

          <footer className="py-6 text-center text-xs text-slate-500">Built with React + Tailwind. Settings are saved in your browser.</footer>

          {/* Inventory modal */}
          {inventoryOpen && (
            <div className="fixed inset-0 z-40 flex items-center justify-center">
              <div className="absolute inset-0 bg-black/40" onClick={()=>setInventoryOpen(false)}></div>
              <div className="relative bg-white rounded-xl shadow-xl p-6 w-full max-w-md max-h-[80vh] overflow-auto">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-slate-800">Inventory</h3>
                  <button className="px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200" onClick={()=>setInventoryOpen(false)}>Close</button>
                </div>
                {inventory ? (
                  <div className="text-sm text-slate-700 space-y-4">
                    {inventory.endpoints && (
                      <div>
                        <h4 className="font-semibold mb-1">Endpoints</h4>
                        <ul className="list-disc list-inside space-y-1">
                          {inventory.endpoints.map((e,i)=>(<li key={i}>{e}</li>))}
                        </ul>
                      </div>
                    )}
                    {inventory.poses && (
                      <div>
                        <h4 className="font-semibold mb-1">Poses</h4>
                        <ul className="list-disc list-inside space-y-1">
                          {inventory.poses.map((p,i)=>(<li key={i}>{p}</li>))}
                        </ul>
                      </div>
                    )}
                    {inventory.motors && (
                      <div>
                        <h4 className="font-semibold mb-1">Motors</h4>
                        <ul className="list-disc list-inside space-y-1">
                          {inventory.motors.map((m,i)=>(<li key={i}>{m}</li>))}
                        </ul>
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="text-sm text-slate-500">No inventory data.</div>
                )}
              </div>
            </div>
          )}

          {/* Admin Drawer */}
          {adminOpen && (
            <div className="fixed inset-0 z-50">
              <div className="absolute inset-0 bg-black/40" onClick={()=>setAdminOpen(false)}></div>
              <aside className="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl p-6 flex flex-col">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-slate-800">Admin panel</h3>
                  <button className="px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200" onClick={()=>setAdminOpen(false)}>Close</button>
                </div>
                <p className="text-sm text-slate-600 mb-4">Connection settings are stored locally in your browser.</p>
                <label className="block text-xs text-slate-600 mb-1">Base URL</label>
                <input className="w-full px-3 py-2 rounded-xl bg-white border border-slate-200 mb-3" placeholder="https://your-ngrok-url.example" value={baseUrl} onChange={e=>setBaseUrl(e.target.value)} />
                <label className="block text-xs text-slate-600 mb-1">API key (optional)</label>
                <input className="w-full px-3 py-2 rounded-xl bg-white border border-slate-200 mb-6" placeholder="api key..." value={apiKey} onChange={e=>setApiKey(e.target.value)} />
                <div className="mt-auto flex gap-2">
                  <button className="px-3 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white" onClick={()=>setAdminOpen(false)}>Save</button>
                  <button className="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-200 text-slate-700" onClick={()=>{setBaseUrl('');setApiKey('');}}>Clear</button>
                </div>
              </aside>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
